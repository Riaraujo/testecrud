<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Quest√µes</title>
    <link rel="icon" href="bastao.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        
        .sidebar-header {
            padding-bottom: 10px;
            border-bottom: 1px solid #3d5166;
            margin-bottom: 15px;
        }
        
        .sidebar-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .sidebar-subtitle {
            font-size: 14px;
            color: #a3b1c6;
        }
        
        .sidebar-menu {
            margin-bottom: 15px;
        }
        
        .sidebar-menu-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #a3b1c6;
            text-transform: uppercase;
        }
        
        .sidebar-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
            width: 100%;
            text-align: left;
        }
        
        .sidebar-button:hover {
            background-color: #2980b9;
        }
        
        .prova-list {
            list-style: none;
            margin-top: 10px;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        .prova-item {
            padding: 8px 10px;
            margin-bottom: 5px;
            background-color: #34495e;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .prova-item:hover {
            background-color: #3d5166;
        }
        
        .prova-item.active {
            background-color: #3498db;
        }
        
        .prova-item-count {
            background-color: rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 12px;
        }
        
        /* Pasta styles */
        .pasta-item {
            padding: 8px 10px;
            margin-bottom: 5px;
            background-color: #8e44ad;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            min-height: 40px;
        }
        
        .pasta-item:hover {
            background-color: #9b59b6;
        }
        
        .pasta-item.active {
            background-color: #e74c3c;
        }
        
        .pasta-icon {
            margin-right: 8px;
        }
        
        /* Context Menu */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            min-width: 150px;
        }
        
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #eee;
        }
        
        .context-menu-item:last-child {
            border-bottom: none;
        }
        
        .context-menu-item:hover {
            background-color: #f5f5f5;
        }
        
        .context-menu-item.danger {
            color: #dc3545;
        }
        
        .context-menu-item.danger:hover {
            background-color: #f8d7da;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        
        .editor-container {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .editor-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .editor-subtitle {
            font-size: 14px;
            color: #666;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        select.form-control {
            height: 36px;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .form-col {
            flex: 1;
        }
        
        /* Linhas e Blocos */
        .linha {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }
        
        .blocos-na-linha {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            min-height: 100px;
            align-items: stretch;
        }
        
        .bloco {
            border-radius: 6px;
            padding: 10px;
            cursor: move;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        
        .bloco-texto {
            background: #f8ffff;
            border: 1px solid #cce8f1;
            flex: 3;
            min-width: 300px;
        }
        
        .bloco-imagem {
            background: #fff8f8;
            border: 1px solid #f1cccc;
            flex: 1;
            min-width: 150px;
        }
        
        .bloco-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .bloco-tipo {
            font-weight: bold;
            font-size: 14px;
            color: #495057;
        }
        
        .controles-bloco button {
            background: #6c757d;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .texto-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .texto-content textarea {
            flex-grow: 1;
            width: 100%;
            min-height: 120px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
        }
        
        .imagem-content input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .controles-texto {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }
        
        .tipo-texto-select, .alinhamento-select {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 13px;
        }
        
        .controles-linha {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn-add-bloco {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .btn-remover-linha {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        /* Alternativas */
        .alternativas-container {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        
        .alternativas-container h3 {
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .alternativa-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }
        
        .alternativa-letra {
            font-weight: bold;
            min-width: 25px;
            text-align: center;
        }
        
        .alternativa-input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .btn-remover-alternativa {
            background: #dc3545;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        /* Bot√µes de a√ß√£o */
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-add-linha {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-salvar {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        
        .btn-voltar {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            border-radius: 8px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #666;
        }
        
        .preview-area {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            max-height: 50vh;
            overflow-y: auto;
        }
        
        #codigo-gerado {
            color: #d4d4d4;
            font-family: Consolas, monospace;
            white-space: pre-wrap;
            margin: 0;
            font-size: 14px;
        }
        
        .btn-copiar {
            background: #17a2b8;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            float: right;
        }
        
        /* Estilos para tipos de texto (NOVOS) */
        .enunciado {
            display: flex;
            align-items: center;
            font-weight: 500 !important;
        }
        
        .poema, .carta {
            white-space: pre-line;
            padding: 10px !important;
        }
        
        .esquerda {
            text-align: left;
        }
        
        .centralizado {
            text-align: center;
        }
        
        .direita {
            text-align: right;
        }
        
        .referencia {
            font-size: small;
            font-style: italic !important;
            color: #636e72 !important;
            margin-top: -20px !important;
            padding: 35px;
            margin-left: -30px;
        }
        
        .cabecalho {
            font-weight: bold !important;
            margin-bottom: 10px !important;
            color: #cc1d75;
        }
        
        /* Estilos para o modal de criar prova */
        .modal-form {
            margin-top: 15px;
        }
        
        .modal-form-group {
            margin-bottom: 15px;
        }
        
        .modal-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .modal-form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn-cancelar {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-confirmar {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* Tabela de quest√µes */
        .questoes-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .questoes-table th {
            background-color: #f8f9fa;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            font-weight: bold;
        }
        
        .questoes-table td {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .questoes-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .btn-table {
            padding: 5px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            margin-right: 5px;
        }
        
        .btn-excluir {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-ver-sql {
            background-color: #17a2b8;
            color: white;
        }

        /* Modal para adicionar JSON ao banco de dados */
        #add-db-modal .modal-content {
            max-width: 600px;
        }

        #add-db-modal textarea {
            width: 100%;
            height: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
        }

    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Editor de Quest√µes</div>
            <div class="sidebar-subtitle">Gerenciamento de Conte√∫do</div>
        </div>
        <div class="sidebar-menu">
            <div class="sidebar-menu-title">Navega√ß√£o</div>
            <button class="sidebar-button" onclick="showCreateQuestionForm()">‚ûï Criar Quest√£o</button>
            <button class="sidebar-button" onclick="showManageQuestions()">üìö Gerenciar Quest√µes</button>
            <button class="sidebar-button" onclick="showCreateProvaModal()">‚ûï Criar Prova</button>
            <button class="sidebar-button" onclick="showCreatePastaModal()">‚ûï Criar Pasta</button>
            <button class="sidebar-button" id="open-add-db-modal-btn">‚ûï Adicionar ao Banco</button>
        </div>
        <div class="sidebar-menu">
            <div class="sidebar-menu-title">Pastas e Provas</div>
            <ul id="pasta-list" class="prova-list">
                <!-- Pastas ser√£o carregadas aqui -->
            </ul>
        </div>
    </div>

    <div class="main-content">
        <div id="create-question-form" class="editor-container" style="display: none;">
            <div class="editor-header">
                <h2 class="editor-title">Criar Nova Quest√£o</h2>
                <span class="editor-subtitle">Preencha os detalhes da quest√£o</span>
            </div>
            <div class="form-group">
                <label for="question-title">T√≠tulo da Quest√£o:</label>
                <input type="text" id="question-title" class="form-control">
            </div>
            <div class="form-row">
                <div class="form-col">
                    <label for="question-index">√çndice:</label>
                    <input type="number" id="question-index" class="form-control">
                </div>
                <div class="form-col">
                    <label for="question-year">Ano:</label>
                    <input type="number" id="question-year" class="form-control">
                </div>
                <div class="form-col">
                    <label for="question-language">Idioma:</label>
                    <input type="text" id="question-language" class="form-control">
                </div>
            </div>
            <div class="form-group">
                <label for="question-discipline">Disciplina:</label>
                <input type="text" id="question-discipline" class="form-control">
            </div>
            <div class="form-group">
                <label for="alternatives-introduction">Introdu√ß√£o das Alternativas:</label>
                <textarea id="alternatives-introduction" class="form-control" rows="3"></textarea>
            </div>
            <div id="linhas-container">
                <!-- Linhas e blocos ser√£o adicionados aqui -->
            </div>
            <button class="btn-add-linha" onclick="adicionarLinha()">‚ûï Adicionar Linha</button>

            <div class="alternativas-container">
                <h3>Alternativas</h3>
                <div id="alternativas-list">
                    <!-- Alternativas ser√£o adicionadas aqui -->
                </div>
                <button class="btn-add-bloco" onclick="adicionarAlternativa()">‚ûï Adicionar Alternativa</button>
            </div>

            <div class="form-group">
                <label for="correct-alternative">Alternativa Correta:</label>
                <input type="text" id="correct-alternative" class="form-control" maxlength="1">
            </div>

            <div class="action-buttons">
                <button class="btn-salvar" onclick="salvarQuestao()">Salvar Quest√£o</button>
            </div>
        </div>

        <div id="manage-questions-section" class="editor-container" style="display: block;">
            <div class="editor-header">
                <h2 class="editor-title">Gerenciar Quest√µes</h2>
                <span class="editor-subtitle">Visualize e edite quest√µes existentes</span>
            </div>
            <div class="form-group">
                <label for="filter-prova">Filtrar por Prova:</label>
                <select id="filter-prova" class="form-control" onchange="loadQuestions()">
                    <option value="">Todas as Provas</option>
                </select>
            </div>
            <table class="questoes-table">
                <thead>
                    <tr>
                        <th>T√≠tulo</th>
                        <th>Disciplina</th>
                        <th>Ano</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="questoes-table-body">
                    <!-- Quest√µes ser√£o carregadas aqui -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal para criar prova -->
    <div id="create-prova-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateProvaModal()">&times;</span>
            <h2>Criar Nova Prova</h2>
            <div class="modal-form">
                <div class="modal-form-group">
                    <label for="prova-name">Nome da Prova:</label>
                    <input type="text" id="prova-name" class="form-control">
                </div>
                <div class="modal-form-group">
                    <label for="prova-pasta">Associar √† Pasta:</label>
                    <select id="prova-pasta" class="form-control">
                        <option value="">Nenhuma</option>
                        <!-- Pastas ser√£o carregadas aqui -->
                    </select>
                </div>
                <div class="modal-buttons">
                    <button class="btn-cancelar" onclick="closeCreateProvaModal()">Cancelar</button>
                    <button class="btn-confirmar" onclick="createProva()">Criar Prova</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para criar pasta -->
    <div id="create-pasta-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreatePastaModal()">&times;</span>
            <h2>Criar Nova Pasta</h2>
            <div class="modal-form">
                <div class="modal-form-group">
                    <label for="pasta-name">Nome da Pasta:</label>
                    <input type="text" id="pasta-name" class="form-control">
                </div>
                <div class="modal-buttons">
                    <button class="btn-cancelar" onclick="closeCreatePastaModal()">Cancelar</button>
                    <button class="btn-confirmar" onclick="createPasta()">Criar Pasta</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NOVO: Modal para adicionar JSON ao banco de dados -->
    <div id="add-db-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddDbModal()">&times;</span>
            <h2>Adicionar Quest√£o via JSON</h2>
            <div class="modal-form">
                <div class="modal-form-group">
                    <label for="json-input">Cole o JSON da quest√£o aqui:</label>
                    <textarea id="json-input" placeholder='{
    "title": "Quest√£o X - ENEM YYYY",
    "index": X,
    "year": YYYY,
    "language": null,
    "discipline": "linguagens",
    "context": "Texto do contexto...",
    "files": [],
    "correctAlternative": "A",
    "alternativesIntroduction": "Introdu√ß√£o das alternativas...",
    "alternatives": [
        { "letter": "A", "text": "Alternativa A", "file": null, "isCorrect": false },
        { "letter": "B", "text": "Alternativa B", "file": null, "isCorrect": false }
    ]
}'></textarea>
                </div>
                <div class="modal-buttons">
                    <button class="btn-cancelar" onclick="closeAddDbModal()">Cancelar</button>
                    <button class="btn-confirmar" onclick="addQuestionFromJson()">Adicionar Quest√£o</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api'; // Certifique-se de que esta URL est√° correta

        // Fun√ß√µes de controle de exibi√ß√£o de se√ß√µes
        function showCreateQuestionForm() {
            document.getElementById('create-question-form').style.display = 'block';
            document.getElementById('manage-questions-section').style.display = 'none';
        }

        function showManageQuestions() {
            document.getElementById('create-question-form').style.display = 'none';
            document.getElementById('manage-questions-section').style.display = 'block';
            loadQuestions(); // Carrega as quest√µes ao exibir a se√ß√£o
        }

        // Fun√ß√µes de modal para criar prova
        function showCreateProvaModal() {
            document.getElementById('create-prova-modal').style.display = 'block';
            loadPastasForProva();
        }

        function closeCreateProvaModal() {
            document.getElementById('create-prova-modal').style.display = 'none';
            document.getElementById('prova-name').value = '';
            document.getElementById('prova-pasta').value = '';
        }

        async function loadPastasForProva() {
            const selectPasta = document.getElementById('prova-pasta');
            selectPasta.innerHTML = '<option value="">Nenhuma</option>';
            try {
                const response = await fetch(`${API_URL}/pastas`);
                const pastas = await response.json();
                pastas.forEach(pasta => {
                    const option = document.createElement('option');
                    option.value = pasta._id;
                    option.textContent = pasta.nome;
                    selectPasta.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar pastas para prova:', error);
                alert('Erro ao carregar pastas para prova.');
            }
        }

        async function createProva() {
            const nome = document.getElementById('prova-name').value;
            const pastaId = document.getElementById('prova-pasta').value;

            if (!nome) {
                alert('O nome da prova √© obrigat√≥rio.');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/provas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nome, pasta: pastaId || null })
                });

                if (response.ok) {
                    alert('Prova criada com sucesso!');
                    closeCreateProvaModal();
                    loadPastas(); // Recarregar a lista de pastas e provas
                } else {
                    const errorData = await response.json();
                    alert(`Erro ao criar prova: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Erro ao criar prova:', error);
                alert('Erro ao criar prova.');
            }
        }

        // Fun√ß√µes de modal para criar pasta
        function showCreatePastaModal() {
            document.getElementById('create-pasta-modal').style.display = 'block';
        }

        function closeCreatePastaModal() {
            document.getElementById('create-pasta-modal').style.display = 'none';
            document.getElementById('pasta-name').value = '';
        }

        async function createPasta() {
            const nome = document.getElementById('pasta-name').value;

            if (!nome) {
                alert('O nome da pasta √© obrigat√≥rio.');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/pastas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nome })
                });

                if (response.ok) {
                    alert('Pasta criada com sucesso!');
                    closeCreatePastaModal();
                    loadPastas(); // Recarregar a lista de pastas e provas
                } else {
                    const errorData = await response.json();
                    alert(`Erro ao criar pasta: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Erro ao criar pasta:', error);
                alert('Erro ao criar pasta.');
            }
        }

        // NOVO: Fun√ß√µes para o modal de adicionar JSON ao banco de dados
        document.getElementById('open-add-db-modal-btn').addEventListener('click', showAddDbModal);

        function showAddDbModal() {
            document.getElementById('add-db-modal').style.display = 'block';
            document.getElementById('json-input').value = ''; // Limpa o textarea
        }

        function closeAddDbModal() {
            document.getElementById('add-db-modal').style.display = 'none';
        }

        async function addQuestionFromJson() {
            const jsonInput = document.getElementById('json-input').value;
            if (!jsonInput) {
                alert('Por favor, cole o JSON da quest√£o.');
                return;
            }

            try {
                const questionData = JSON.parse(jsonInput);

                const response = await fetch(`${API_URL}/questoes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(questionData)
                });

                if (response.ok) {
                    alert('Quest√£o adicionada com sucesso!');
                    closeAddDbModal();
                    loadQuestions(); // Recarrega a lista de quest√µes
                    loadPastas(); // Recarrega a lista de pastas e provas (caso novas tenham sido criadas)
                } else {
                    const errorData = await response.json();
                    alert(`Erro ao adicionar quest√£o: ${errorData.error || response.statusText}`);
                }
            } catch (error) {
                console.error('Erro ao processar JSON ou adicionar quest√£o:', error);
                alert('Erro ao processar JSON ou adicionar quest√£o. Verifique o formato do JSON.');
            }
        }

        // Fun√ß√µes de carregamento de pastas e provas
        async function loadPastas() {
            const pastaList = document.getElementById('pasta-list');
            pastaList.innerHTML = '';
            try {
                const response = await fetch(`${API_URL}/pastas`);
                const pastas = await response.json();

                for (const pasta of pastas) {
                    const pastaItem = document.createElement('li');
                    pastaItem.className = 'pasta-item';
                    pastaItem.innerHTML = `
                        <span class="pasta-icon">üìÅ</span>
                        <span>${pasta.nome}</span>
                        <div class="pasta-actions">
                            <button class="btn-table" onclick="event.stopPropagation(); deletePasta('${pasta._id}')">Excluir</button>
                        </div>
                    `;
                    pastaList.appendChild(pastaItem);

                    if (pasta.provas && pasta.provas.length > 0) {
                        const provasUl = document.createElement('ul');
                        provasUl.style.listStyle = 'none';
                        provasUl.style.paddingLeft = '20px';
                        for (const provaId of pasta.provas) {
                            try {
                                const provaResponse = await fetch(`${API_URL}/provas/${provaId}`);
                                if (provaResponse.ok) {
                                    const prova = await provaResponse.json();
                                    const provaItem = document.createElement('li');
                                    provaItem.className = 'prova-item';
                                    provaItem.textContent = prova.nome;
                                    provaItem.dataset.provaId = prova._id; // Armazena o ID da prova
                                    provaItem.onclick = () => filterQuestionsByProva(prova._id);
                                    provaItem.innerHTML += `
                                        <div class="prova-actions">
                                            <button class="btn-table" onclick="event.stopPropagation(); deleteProva('${prova._id}')">Excluir</button>
                                        </div>
                                    `;
                                    provasUl.appendChild(provaItem);
                                } else {
                                    console.warn(`Prova com ID ${provaId} n√£o encontrada.`);
                                }
                            } catch (error) {
                                console.error(`Erro ao carregar prova ${provaId}:`, error);
                            }
                        }
                        pastaList.appendChild(provasUl);
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar pastas:', error);
                alert('Erro ao carregar pastas.');
            }
        }

        // Fun√ß√µes de carregamento e filtragem de quest√µes
        async function loadQuestions() {
            const questoesTableBody = document.getElementById('questoes-table-body');
            questoesTableBody.innerHTML = '';
            const filterProvaId = document.getElementById('filter-prova').value;

            try {
                const url = filterProvaId ? `${API_URL}/provas/${filterProvaId}/questoes` : `${API_URL}/questoes`;
                const response = await fetch(url);
                const questoes = await response.json();

                questoes.forEach(questao => {
                    const row = questoesTableBody.insertRow();
                    row.insertCell().textContent = questao.title || 'Sem T√≠tulo';
                    row.insertCell().textContent = questao.discipline || 'N/A';
                    row.insertCell().textContent = questao.year || 'N/A';
                    const actionsCell = row.insertCell();
                    actionsCell.innerHTML = `
                        <button class="btn-table btn-excluir" onclick="deleteQuestao('${questao._id}')">Excluir</button>
                        <button class="btn-table btn-ver-sql" onclick="viewQuestao('${questao._id}')">Ver JSON</button>
                    `;
                });
            } catch (error) {
                console.error('Erro ao carregar quest√µes:', error);
                alert('Erro ao carregar quest√µes.');
            }
        }

        async function filterQuestionsByProva(provaId) {
            document.getElementById('filter-prova').value = provaId;
            loadQuestions();
        }

        // Fun√ß√µes de exclus√£o
        async function deletePasta(id) {
            if (!confirm('Tem certeza que deseja excluir esta pasta e todas as provas e quest√µes associadas?')) {
                return;
            }
            try {
                const response = await fetch(`${API_URL}/pastas/${id}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    alert('Pasta exclu√≠da com sucesso!');
                    loadPastas();
                    loadQuestions();
                } else {
                    const errorData = await response.json();
                    alert(`Erro ao excluir pasta: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Erro ao excluir pasta:', error);
                alert('Erro ao excluir pasta.');
            }
        }

        async function deleteProva(id) {
            if (!confirm('Tem certeza que deseja excluir esta prova e todas as quest√µes associadas?')) {
                return;
            }
            try {
                const response = await fetch(`${API_URL}/provas/${id}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    alert('Prova exclu√≠da com sucesso!');
                    loadPastas();
                    loadQuestions();
                } else {
                    const errorData = await response.json();
                    alert(`Erro ao excluir prova: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Erro ao excluir prova:', error);
                alert('Erro ao excluir prova.');
            }
        }

        async function deleteQuestao(id) {
            if (!confirm('Tem certeza que deseja excluir esta quest√£o?')) {
                return;
            }
            try {
                const response = await fetch(`${API_URL}/questoes/${id}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    alert('Quest√£o exclu√≠da com sucesso!');
                    loadQuestions();
                    loadPastas(); // Atualiza contagem de quest√µes nas provas
                } else {
                    const errorData = await response.json();
                    alert(`Erro ao excluir quest√£o: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Erro ao excluir quest√£o:', error);
                alert('Erro ao excluir quest√£o.');
            }
        }

        async function viewQuestao(id) {
            try {
                const response = await fetch(`${API_URL}/questoes/${id}`);
                if (response.ok) {
                    const questao = await response.json();
                    const jsonString = JSON.stringify(questao, null, 2);
                    alert('JSON da Quest√£o:\n\n' + jsonString);
                } else {
                    alert('Quest√£o n√£o encontrada.');
                }
            } catch (error) {
                console.error('Erro ao buscar quest√£o:', error);
                alert('Erro ao buscar quest√£o.');
            }
        }

        // Fun√ß√µes de manipula√ß√£o do formul√°rio de cria√ß√£o de quest√£o
        let linhaCounter = 0;
        let alternativaCounter = 0;

        function adicionarLinha() {
            linhaCounter++;
            const linhasContainer = document.getElementById('linhas-container');
            const novaLinha = document.createElement('div');
            novaLinha.className = 'linha';
            novaLinha.id = `linha-${linhaCounter}`;
            novaLinha.innerHTML = `
                <div class="blocos-na-linha" id="blocos-linha-${linhaCounter}">
                    <!-- Blocos ser√£o adicionados aqui -->
                </div>
                <div class="controles-linha">
                    <button class="btn-add-bloco" onclick="adicionarBlocoTexto(${linhaCounter})">‚ûï Texto</button>
                    <button class="btn-add-bloco" onclick="adicionarBlocoImagem(${linhaCounter})">‚ûï Imagem</button>
                    <button class="btn-remover-linha" onclick="removerLinha(${linhaCounter})">Remover Linha</button>
                </div>
            `;
            linhasContainer.appendChild(novaLinha);
            new Sortable(document.getElementById(`blocos-linha-${linhaCounter}`), {
                animation: 150,
                group: 'shared',
                onEnd: function (evt) {
                    // L√≥gica para reordenar blocos se necess√°rio
                }
            });
        }

        function removerLinha(id) {
            document.getElementById(`linha-${id}`).remove();
        }

        function adicionarBlocoTexto(linhaId) {
            const blocosContainer = document.getElementById(`blocos-linha-${linhaId}`);
            const novoBloco = document.createElement('div');
            novoBloco.className = 'bloco bloco-texto';
            novoBloco.innerHTML = `
                <div class="bloco-header">
                    <span class="bloco-tipo">Texto</span>
                    <div class="controles-bloco">
                        <button onclick="removerBloco(this)">‚úñ</button>
                    </div>
                </div>
                <div class="controles-texto">
                    <select class="tipo-texto-select" onchange="aplicarEstiloTexto(this)">
                        <option value="normal">Normal</option>
                        <option value="enunciado">Enunciado</option>
                        <option value="referencia">Refer√™ncia</option>
                        <option value="cabecalho">Cabe√ßalho</option>
                        <option value="poema">Poema</option>
                        <option value="carta">Carta</option>
                    </select>
                    <select class="alinhamento-select" onchange="aplicarAlinhamentoTexto(this)">
                        <option value="esquerda">Esquerda</option>
                        <option value="centralizado">Centralizado</option>
                        <option value="direita">Direita</option>
                    </select>
                </div>
                <div class="texto-content">
                    <textarea placeholder="Digite o texto aqui..."></textarea>
                </div>
            `;
            blocosContainer.appendChild(novoBloco);
        }

        function adicionarBlocoImagem(linhaId) {
            const blocosContainer = document.getElementById(`blocos-linha-${linhaId}`);
            const novoBloco = document.createElement('div');
            novoBloco.className = 'bloco bloco-imagem';
            novoBloco.innerHTML = `
                <div class="bloco-header">
                    <span class="bloco-tipo">Imagem</span>
                    <div class="controles-bloco">
                        <button onclick="removerBloco(this)">‚úñ</button>
                    </div>
                </div>
                <div class="imagem-content">
                    <input type="text" placeholder="URL da Imagem">
                </div>
            `;
            blocosContainer.appendChild(novoBloco);
        }

        function removerBloco(button) {
            button.closest('.bloco').remove();
        }

        function aplicarEstiloTexto(selectElement) {
            const textarea = selectElement.closest('.bloco-texto').querySelector('textarea');
            textarea.className = 'form-control ' + selectElement.value;
        }

        function aplicarAlinhamentoTexto(selectElement) {
            const textarea = selectElement.closest('.bloco-texto').querySelector('textarea');
            textarea.style.textAlign = selectElement.value;
        }

        function adicionarAlternativa() {
            alternativaCounter++;
            const alternativasList = document.getElementById('alternativas-list');
            const novaAlternativa = document.createElement('div');
            novaAlternativa.className = 'alternativa-item';
            const letter = String.fromCharCode(64 + alternativaCounter); // A, B, C, ...
            novaAlternativa.innerHTML = `
                <span class="alternativa-letra">${letter})</span>
                <input type="text" class="alternativa-input" placeholder="Texto da alternativa ${letter}">
                <button class="btn-remover-alternativa" onclick="removerAlternativa(this)">‚úñ</button>
            `;
            alternativasList.appendChild(novaAlternativa);
        }

        function removerAlternativa(button) {
            button.closest('.alternativa-item').remove();
            // Reajustar as letras das alternativas ap√≥s a remo√ß√£o
            const alternativas = document.querySelectorAll('.alternativa-item');
            alternativas.forEach((alt, index) => {
                alt.querySelector('.alternativa-letra').textContent = `${String.fromCharCode(65 + index)})`;
            });
            alternativaCounter = alternativas.length;
        }

        async function salvarQuestao() {
            const title = document.getElementById('question-title').value;
            const index = parseInt(document.getElementById('question-index').value);
            const year = parseInt(document.getElementById('question-year').value);
            const language = document.getElementById('question-language').value || null;
            const discipline = document.getElementById('question-discipline').value;
            const alternativesIntroduction = document.getElementById('alternatives-introduction').value;
            const correctAlternative = document.getElementById('correct-alternative').value.toUpperCase();

            const contextParts = [];
            const files = [];

            document.querySelectorAll('.linha').forEach(linha => {
                linha.querySelectorAll('.bloco').forEach(bloco => {
                    if (bloco.classList.contains('bloco-texto')) {
                        const textarea = bloco.querySelector('textarea');
                        const tipo = bloco.querySelector('.tipo-texto-select').value;
                        const alinhamento = bloco.querySelector('.alinhamento-select').value;
                        let text = textarea.value;

                        // Adiciona classes HTML para estilo e alinhamento
                        let styledText = `<div class="${tipo} ${alinhamento}">${text}</div>`;
                        contextParts.push(styledText);

                    } else if (bloco.classList.contains('bloco-imagem')) {
                        const imageUrl = bloco.querySelector('input').value;
                        if (imageUrl) {
                            files.push(imageUrl);
                            contextParts.push(`<img src="${imageUrl}" alt="Imagem da Quest√£o">`);
                        }
                    }
                });
            });

            // Concatena as partes do contexto com quebras de linha HTML
            const context = contextParts.join('\n');

            const alternatives = [];
            document.querySelectorAll('.alternativa-item').forEach((item, idx) => {
                const letter = String.fromCharCode(65 + idx);
                const text = item.querySelector('.alternativa-input').value;
                alternatives.push({
                    letter: letter,
                    text: text,
                    file: null, // N√£o estamos coletando arquivos para alternativas no momento
                    isCorrect: (letter === correctAlternative)
                });
            });

            const questionData = {
                title,
                index,
                year,
                language,
                discipline,
                context,
                files,
                correctAlternative,
                alternativesIntroduction,
                alternatives
            };

            console.log('Dados da quest√£o a serem enviados:', questionData);

            try {
                const response = await fetch(`${API_URL}/questoes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(questionData)
                });

                if (response.ok) {
                    alert('Quest√£o salva com sucesso!');
                    // Limpar formul√°rio ou redirecionar
                    // resetForm();
                    loadQuestions();
                    loadPastas(); // Recarrega as pastas para atualizar as contagens e novas provas
                } else {
                    const errorData = await response.json();
                    alert(`Erro ao salvar quest√£o: ${errorData.error || response.statusText}`);
                }
            } catch (error) {
                console.error('Erro ao salvar quest√£o:', error);
                alert('Erro de conex√£o ao salvar quest√£o.');
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            loadPastas();
            loadQuestions();
            showManageQuestions(); // Exibe a se√ß√£o de gerenciar quest√µes por padr√£o
        });

    </script>
</body>
</html>

